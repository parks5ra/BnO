var AnalyticsSDK=(()=>{var C=Object.defineProperty,ue=Object.defineProperties,ce=Object.getOwnPropertyDescriptor,le=Object.getOwnPropertyDescriptors,de=Object.getOwnPropertyNames,Z=Object.getOwnPropertySymbols;var te=Object.prototype.hasOwnProperty,me=Object.prototype.propertyIsEnumerable;var ee=(s,e,t)=>e in s?C(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,y=(s,e)=>{for(var t in e||(e={}))te.call(e,t)&&ee(s,t,e[t]);if(Z)for(var t of Z(e))me.call(e,t)&&ee(s,t,e[t]);return s},re=(s,e)=>ue(s,le(e));var pe=(s,e)=>{for(var t in e)C(s,t,{get:e[t],enumerable:!0})},he=(s,e,t,i)=>{if(e&&typeof e=="object"||typeof e=="function")for(let r of de(e))!te.call(s,r)&&r!==t&&C(s,r,{get:()=>e[r],enumerable:!(i=ce(e,r))||i.enumerable});return s};var Se=s=>he(C({},"__esModule",{value:!0}),s);var o=(s,e,t)=>new Promise((i,r)=>{var n=l=>{try{c(t.next(l))}catch(h){r(h)}},a=l=>{try{c(t.throw(l))}catch(h){r(h)}},c=l=>l.done?i(l.value):Promise.resolve(l.value).then(n,a);c((t=t.apply(s,e)).next())});var ve={};pe(ve,{default:()=>Ie});var m=[];for(let s=0;s<256;++s)m.push((s+256).toString(16).slice(1));function ie(s,e=0){return(m[s[e+0]]+m[s[e+1]]+m[s[e+2]]+m[s[e+3]]+"-"+m[s[e+4]]+m[s[e+5]]+"-"+m[s[e+6]]+m[s[e+7]]+"-"+m[s[e+8]]+m[s[e+9]]+"-"+m[s[e+10]]+m[s[e+11]]+m[s[e+12]]+m[s[e+13]]+m[s[e+14]]+m[s[e+15]]).toLowerCase()}var W,ye=new Uint8Array(16);function K(){if(!W){if(typeof crypto=="undefined"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");W=crypto.getRandomValues.bind(crypto)}return W(ye)}var we=typeof crypto!="undefined"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),$={randomUUID:we};function be(s,e,t){if($.randomUUID&&!e&&!s)return $.randomUUID();s=s||{};let i=s.random||(s.rng||K)();if(i[6]=i[6]&15|64,i[8]=i[8]&63|128,e){t=t||0;for(let r=0;r<16;++r)e[t+r]=i[r];return e}return ie(i)}var J=be;function U(){return J()}var p=class{constructor(e,t,i,r,n,a,c,l){this.eventName=e;this.timestamp=t;this.clientId=i;this.sessionId=r;this.merchantId=n;this.shopperCountryCode=a;this.category=c;this.cdn=l;this.isSdk=!0}};var D=class extends p{constructor(t,i,r,n,a,c,l,h,f,T,w,b,I,g,d,V,X){super("Page View",t,i,r,n,a,c,l);this.timestamp=t;this.clientId=i;this.sessionId=r;this.merchantId=n;this.shopperCountryCode=a;this.category=c;this.cdn=l;this.pageUrl=h;this.pageTitle=f;this.screenResolution=T;this.userAgent=w;this.referrer=b;this.utmSource=I;this.utmMedium=g;this.utmCampaign=d;this.utmTerm=V;this.utmContent=X}};var L=class extends p{constructor(t,i,r,n,a,c,l,h,f,T,w,b,I,g,d,V,X){super("Browsing Start",t,i,r,n,a,c,l);this.timestamp=t;this.clientId=i;this.sessionId=r;this.merchantId=n;this.shopperCountryCode=a;this.category=c;this.cdn=l;this.pageUrl=h;this.pageTitle=f;this.screenResolution=T;this.userAgent=w;this.referrer=b;this.utmSource=I;this.utmMedium=g;this.utmCampaign=d;this.utmTerm=V;this.utmContent=X}};var v=class extends Error{constructor(e){super(`The "${e}" is not supported.`)}};function u(s){return{toBeDefined(e){if(s==null||typeof s=="string"&&s.trim()==="")throw new Error(e!=null?e:"The value is not defined.");return s},toThrowNotSupported(e){throw new v(e)}}}function z(s){let e=s.split(".").filter(Boolean);return e.length>=2?`.${e.slice(-2).join(".")}`:s}var P=class{constructor(e){this.window=u(e).toBeDefined("The window object is required to construct DefaultBrowserAccessor."),this.sessionStorageAsyncWrapper={getItem:t=>Promise.resolve(this.window.sessionStorage.getItem(t)),setItem:(t,i)=>Promise.resolve(this.window.sessionStorage.setItem(t,i)),removeItem:t=>Promise.resolve(this.window.sessionStorage.removeItem(t))},this.localStorageAsyncWrapper={getItem:t=>Promise.resolve(this.window.localStorage.getItem(t)),setItem:(t,i)=>Promise.resolve(this.window.localStorage.setItem(t,i)),removeItem:t=>Promise.resolve(this.window.localStorage.removeItem(t))},this.cookieStorageAsyncWrapper={getItem:t=>{let i=t+"=",n=this.window.document.cookie.split(";").map(a=>a.trim()).find(a=>a.startsWith(i));return Promise.resolve(n?n.substring(i.length):null)},setItem:(t,i)=>{let r=z(this.window.location.hostname),n=new Date(Date.now()+2*365*24*60*60*1e3).toUTCString();return this.window.document.cookie=`${t}=${encodeURIComponent(i)}; expires=${n}; path=/; domain=${r}`,Promise.resolve()},removeItem:t=>{let i=z(this.window.location.hostname);return this.window.document.cookie=`${t}=;expires=Thu, 01 Jan 1970 00:00:00 UTC;path=/;domain=${i}`,Promise.resolve()}}}getPageUrl(){return this.window.location.href}getPageTitle(){return this.window.document.title}getScreenResolution(){return`${this.window.screen.width}x${this.window.screen.height}`}getUserAgent(){return this.window.navigator.userAgent}getReferrer(){return this.window.document.referrer}get sessionStorage(){return this.sessionStorageAsyncWrapper}get localStorage(){return this.localStorageAsyncWrapper}get cookieStorage(){return this.cookieStorageAsyncWrapper}createTrackingPixel(e){let t=this.window.document.createElement("img");t.width=1,t.height=1,t.src=e}createIFrame(e,t,i,r){let n=this.window.document.getElementById(t.attributes.id);n||(n=this.window.document.createElement("iframe"),n.setAttribute("id",t.attributes.id),n.setAttribute("title",t.attributes.title),n.setAttribute("width",t.attributes.width),n.setAttribute("height",t.attributes.height),n.style.display="none",this.window.document.getElementsByTagName("body")[0].appendChild(n)),n.setAttribute("src",e)}},M=class{constructor(e,t){this._sessionStorage=u(e).toBeDefined(),this._localStorage=u(t).toBeDefined()}getPageUrl(){}getPageTitle(){}getScreenResolution(){}getUserAgent(){}getReferrer(){}get sessionStorage(){return this._sessionStorage}get localStorage(){return this._localStorage}get cookieStorage(){throw new Error("Method not implemented.")}createTrackingPixel(e){}createIFrame(e,t,i,r){}};var S="GlobalE_Analytics_UTMs",se="utm_source",ne="utm_medium",oe="utm_campaign",ae="utm_term",ge="utm_content",x=class{constructor(e,t,i){var r,n,a;this.browser=u(e).toBeDefined("The IBrowserAccessor implementation is required to construct UtmHandler."),this.logger=u(t).toBeDefined("The ILogger implementation is required to construct UtmHandler."),this.FT_3DA=(r=i==null?void 0:i.FT_3DA)!=null?r:!0,this.FT_3DA_UTM_SOURCE_LIST=(n=i==null?void 0:i.FT_3DA_UTM_SOURCE_LIST)!=null?n:["borderfree"],this.FT_3DA_STORAGE_LIFETIME=(a=i==null?void 0:i.FT_3DA_STORAGE_LIFETIME)!=null?a:4320}handle(e){return o(this,null,function*(){let t=this.getUtmParams(e),r=yield this.selectStorageStrategy().execute(t);this.utmSource=r.utmSource,this.utmMedium=r.utmMedium,this.utmCampaign=r.utmCampaign,this.utmTerm=r.utmTerm,this.utmContent=r.utmContent})}getUtmParams(e){var w,b,I;let t="direct",i="(none)",r="(not-set)";try{if(n(e))return c(e);if(a(e))return e;let g=new URL(this.browser.getPageUrl());return{utmSource:(w=g.searchParams.get(se))!=null?w:h(this.browser),utmMedium:(b=g.searchParams.get(ne))!=null?b:f(this.browser),utmCampaign:(I=g.searchParams.get(oe))!=null?I:T(),utmTerm:g.searchParams.get(ae),utmContent:g.searchParams.get(ge)}}catch(g){return this.logger.writeErrorLog({method:"UtmHandler::getUtmParams()",message:g.message,errorMessage:g.message,errorStackTrace:g.stackTrace}),{utmSource:t,utmMedium:i,utmCampaign:r,utmTerm:null,utmContent:null}}function n(g){return typeof g=="string"}function a(g){return typeof g=="object"&&g!==null&&"utmSource"in g&&"utmMedium"in g&&"utmCampaign"in g&&typeof g.utmSource=="string"&&typeof g.utmMedium=="string"&&typeof g.utmCampaign=="string"}function c(g){let d=new URLSearchParams(g);return{utmSource:d.get(se),utmMedium:d.get(ne),utmCampaign:d.get(oe),utmTerm:d.get(ae),utmContent:d.get(ge)}}function l(g){return g}function h(g){let d=g.getReferrer();return d?d.includes("google")?"google":d.includes("borderfree")?"borderfree":d:t}function f(g){let d=g.getReferrer();return d?d.includes("google")?"organic":"referral":i}function T(){return r}}selectStorageStrategy(){return this.FT_3DA?new Q(this.browser,this.FT_3DA_UTM_SOURCE_LIST,this.FT_3DA_STORAGE_LIFETIME):new Y(this.browser)}},Q=class{constructor(e,t,i){this.browser=u(e).toBeDefined("The IBrowserAccessor implementation is required to construct DefaultStorageStrategy."),this.FT_3DA_UTM_SOURCE_LIST=t,this.FT_3DA_STORAGE_LIFETIME=i}execute(e){return o(this,null,function*(){let t=Date.now(),i=this.FT_3DA_UTM_SOURCE_LIST.includes(e.utmSource),r=yield this.browser.localStorage.getItem(S);if(r)try{let n=JSON.parse(r);if(n.expiry&&t<n.expiry)return i&&(n.expiry=t+this.FT_3DA_STORAGE_LIFETIME*6e4,yield this.browser.localStorage.setItem(S,JSON.stringify(n))),n;yield this.browser.localStorage.removeItem(S)}catch(n){yield this.browser.localStorage.removeItem(S)}if(i){let n=re(y({},e),{expiry:t+this.FT_3DA_STORAGE_LIFETIME*6e4});return yield this.browser.localStorage.setItem(S,JSON.stringify(n)),yield this.browser.sessionStorage.removeItem(S),n}else{let n=yield this.browser.sessionStorage.getItem(S);if(n===null)return yield this.browser.sessionStorage.setItem(S,JSON.stringify(e)),e;try{return JSON.parse(n)}catch(a){return yield this.browser.sessionStorage.removeItem(S),null}}})}},Y=class{constructor(e){this.browser=u(e).toBeDefined("The IBrowserAccessor implementation is required to construct DefaultStorageStrategy.")}execute(e){return o(this,null,function*(){let t=yield this.browser.sessionStorage.getItem(S);if(t===null)return yield this.browser.sessionStorage.setItem(S,JSON.stringify(e)),e;try{return JSON.parse(t)}catch(i){return yield this.browser.sessionStorage.removeItem(S),null}})}};var A=class{constructor(){}get(e){return o(this,null,function*(){return yield(yield fetch(e,{method:"GET",headers:{"Content-Type":"application/json"}})).json()})}post(e,t){return o(this,null,function*(){return yield(yield fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)})).json()})}};var R=class{constructor(e,t){this.http=t,this.cdn=e}send(e){return o(this,null,function*(){yield this.http.post(this.cdn,e)})}};var F=class{constructor(e,t){this.cdn=u(e).toBeDefined("The CDN is required to initialize TrackingPixelEventSender."),this.browser=u(t).toBeDefined("The IBrowserAccessor implementation is required to initialize TrackingPixelEventSender.")}send(e){let t=new URL("/client",this.cdn);for(let i in e){let r=e[i];r!=null&&(r&&typeof r=="object"&&(r=JSON.stringify(r)),t.searchParams.append(E.map(i),r))}return this.browser.createTrackingPixel(t.toString()),Promise.resolve()}},E=class{static map(e){switch(e){case"eventName":return"e";case"timestamp":return"t";case"clientId":return"cid";case"sessionId":return"sid";case"merchantId":return"mid";case"shopperCountryCode":return"scc";case"category":return"c";case"cdn":return"cdn";case"pageUrl":return"p";case"pageTitle":return"pt";case"screenResolution":return"sr";case"userAgent":return"ua";case"referrer":return"ref";case"utmSource":return"utm_source";case"utmMedium":return"utm_medium";case"utmCampaign":return"utm_campaign";case"utmTerm":return"utm_term";case"utmContent":return"utm_content";default:return e}}};var B=class{constructor(e,t){var i;this.url=u(e).toBeDefined("The URL of the logging server is required to initialize DataTrackingServiceLogger."),this.http=(i=t==null?void 0:t.http)!=null?i:new A}writeLog(i){return o(this,arguments,function*(e,t=3){try{let r={severity:t};typeof e=="string"?r.message=e:r=y(y({},r),e),yield this.http.post(this.url,r)}catch(r){console.error(`DataTrackingServiceLogger::writeLog() - error occured: ${r.message}`,r)}})}writeDebugLog(e){return o(this,null,function*(){return this.writeLog(e,1)})}writeVerboseLog(e){return o(this,null,function*(){return this.writeLog(e,2)})}writeInfoLog(e){return o(this,null,function*(){return this.writeLog(e,3)})}writeWarningLog(e){return o(this,null,function*(){return this.writeLog(e,4)})}writeErrorLog(e){return o(this,null,function*(){return this.writeLog(e,5)})}writeCriticalLog(e){return o(this,null,function*(){return this.writeLog(e,6)})}};var _=class{constructor(){this.logs=[];this.logsLimit=100}writeLog(i){return o(this,arguments,function*(e,t=3){try{let r={timestamp:Date.now(),severity:t};return typeof e=="string"?r.message=e:r=y(y({},r),e),this.logs.push(r),this.logs.length>this.logsLimit&&this.logs.shift(),Promise.resolve()}catch(r){}})}writeDebugLog(e){return o(this,null,function*(){return this.writeLog(e,1)})}writeVerboseLog(e){return o(this,null,function*(){return this.writeLog(e,2)})}writeInfoLog(e){return o(this,null,function*(){return this.writeLog(e,3)})}writeWarningLog(e){return o(this,null,function*(){return this.writeLog(e,4)})}writeErrorLog(e){return o(this,null,function*(){return this.writeLog(e,5)})}writeCriticalLog(e){return o(this,null,function*(){return this.writeLog(e,6)})}},k=class{constructor(e){this.debugOnly=e!=null?e:!1}writeLog(i){return o(this,arguments,function*(e,t=3){try{if(this.debugOnly)console.debug(e);else switch(t){case 1:console.debug(e);break;case 2:console.trace(e);break;case 3:console.info(e);break;case 4:console.warn(e);break;case 5:console.error(e);break;case 6:console.error(e);break;default:break}return Promise.resolve()}catch(r){}})}writeDebugLog(e){return o(this,null,function*(){return this.writeLog(e,1)})}writeVerboseLog(e){return o(this,null,function*(){return this.writeLog(e,2)})}writeInfoLog(e){return o(this,null,function*(){return this.writeLog(e,3)})}writeWarningLog(e){return o(this,null,function*(){return this.writeLog(e,4)})}writeErrorLog(e){return o(this,null,function*(){return this.writeLog(e,5)})}writeCriticalLog(e){return o(this,null,function*(){return this.writeLog(e,6)})}};var O=class extends p{constructor(t,i,r,n,a,c,l,h,f,T,w,b,I,g){super("Checkout Start",t,i,r,n,a,c,l);this.timestamp=t;this.clientId=i;this.sessionId=r;this.merchantId=n;this.shopperCountryCode=a;this.category=c;this.cdn=l;this.checkoutToken=h;this.userAgent=f;this.utmSource=T;this.utmMedium=w;this.utmCampaign=b;this.utmTerm=I;this.utmContent=g}};var j=class extends p{constructor(t,i,r,n,a,c,l,h,f,T,w,b,I,g,d,V){super(t,i,r,n,a,c,l,h);this.eventName=t;this.timestamp=i;this.clientId=r;this.sessionId=n;this.merchantId=a;this.shopperCountryCode=c;this.category=l;this.cdn=h;this.checkoutToken=f;this.userAgent=T;this.utmSource=w;this.utmMedium=b;this.utmCampaign=I;this.utmTerm=g;this.utmContent=d;this.data=V}};var N=class extends p{constructor(t,i,r,n,a,c,l,h,f,T,w,b,I,g,d,V,X,fe,Te){super(t,i,r,n,a,c,l,h);this.eventName=t;this.timestamp=i;this.clientId=r;this.sessionId=n;this.merchantId=a;this.shopperCountryCode=c;this.category=l;this.cdn=h;this.pageUrl=f;this.pageTitle=T;this.screenResolution=w;this.userAgent=b;this.referrer=I;this.utmSource=g;this.utmMedium=d;this.utmCampaign=V;this.utmTerm=X;this.utmContent=fe;this.data=Te}};var G=class{constructor(e,t){this.cdn=u(e).toBeDefined("The CDN is required to initialize ShopifyFetchEventSender."),this.http=u(t).toBeDefined("The IHttp implementation is required to initialize ShopifyFetchEventSender")}send(e){let t=new URL("/client",this.cdn);for(let i in e){let r=e[i];r!=null&&(r&&typeof r=="object"&&(r=JSON.stringify(r)),t.searchParams.append(E.map(i),r))}return this.http.get(t.toString())}};var q=class{constructor(e,t){this.browser=e,this.logger=t}saveData(e,t){return o(this,null,function*(){var i;try{let r=JSON.stringify(t);yield Promise.all([this.browser.localStorage.setItem(e,r),this.browser.cookieStorage.setItem(e,r)])}catch(r){throw(i=this.logger)==null||i.writeErrorLog({method:"DataStorageManager::saveData()",message:r.message,errorMessage:r.stack||r.message}),new Error(`Failed to save data: ${r.message}`)}})}loadData(e){return o(this,null,function*(){var r,n;let t=null,i=null;try{let a=yield this.browser.cookieStorage.getItem(e);if(a){let c=decodeURIComponent(a);t=JSON.parse(c)}}catch(a){(r=this.logger)==null||r.writeWarningLog({method:"DataStorageManager::loadData()",message:"Failed to parse cookie data.",errorMessage:a.message})}try{let a=yield this.browser.localStorage.getItem(e);a&&(i=JSON.parse(a))}catch(a){(n=this.logger)==null||n.writeWarningLog({method:"DataStorageManager::loadData()",message:"Failed to parse localStorage data.",errorMessage:a.message})}return this.getFreshestValidSnapshot(t,i)})}clearData(e){return o(this,null,function*(){var t;try{yield Promise.all([this.browser.localStorage.removeItem(e),this.browser.cookieStorage.removeItem(e)])}catch(i){throw(t=this.logger)==null||t.writeErrorLog({method:"DataStorageManager::clearData()",message:"Failed to clear data.",errorMessage:i.message}),new Error(`Failed to clear data: ${i.message}`)}})}getFreshestValidSnapshot(e,t){if(e&&t){let i=e==null?void 0:e.dataUpdatedAt,r=t==null?void 0:t.dataUpdatedAt;if(i&&r)return i>r?e:t}return e!=null?e:t}};var H=class{constructor(e,t){this.ANALYTICS_STORAGE_KEY="GlobalE_Analytics";this.eventQueue=[];this.isConfigurationLoaded=!1;this.isInitialized=!1;this.FT_3DA=!0;this.FT_3DA_UTM_SOURCE_LIST=["borderfree"];this.FT_3DA_STORAGE_LIFETIME=4320;this.DATA_TRACKING_SERVICE_API_URL="https://utils.global-e.com",this.MONOLITH_API_URL="",this.http=e!=null?e:new A,this.logger=t!=null?t:new _}get ClientId(){return this.clientId}get SessionId(){return this.sessionId}get UtmSource(){return this.utms.utmSource}get UtmMedium(){return this.utms.utmMedium}get UtmCampaign(){return this.utms.utmCampaign}loadConfigurationSnapshot(){return o(this,null,function*(){try{let e=yield this.dataStorageManager.loadData(this.ANALYTICS_STORAGE_KEY);if(e===null){this.logger.writeInfoLog({method:"AnalyticsSDK::loadConfigurationSnapshot()",message:"Snapshot is not found in Local Storage"});return}this.merchantId=u(e.merchantId).toBeDefined("Snapshot integrity violated. The `merchantId` is missing."),this.shopperCountryCode=e.shopperCountryCode,this.cdn=u(e.cdn).toBeDefined("Snapshot integrity violated. The `cdn` is missing."),this.clientId=u(e.clientId).toBeDefined("Snapshot integrity violated. The `clientId` is missing."),this.sessionId=e.sessionId,this.sessionIdExpiry=e.sessionIdExpiry,this.eventSendingStrategy=e.configurations.eventSendingStrategy,this.FT_3DA=e.featureToggles.FT_3DA,this.FT_3DA_UTM_SOURCE_LIST=e.featureToggles.FT_3DA_UTM_SOURCE_LIST,this.FT_3DA_STORAGE_LIFETIME=e.featureToggles.FT_3DA_STORAGE_LIFETIME,this.lockBrowsingStartOnSessionId=e.lockBrowsingStartOnSessionId,this.lockCheckoutStartOnSessionId=e.lockCheckoutStartOnSessionId,this.dataUpdatedAt=e.dataUpdatedAt,this.dataLayer=e.dataLayer,this.isConfigurationLoaded=!0}catch(e){this.logger.writeWarningLog({method:"AnalyticsSDK::loadConfigurationSnapshot()",message:e.message,errorMessage:e.message})}})}saveConfigurationSnapshot(){return o(this,null,function*(){let e={merchantId:this.merchantId,shopperCountryCode:this.shopperCountryCode,cdn:this.cdn,clientId:this.clientId,sessionId:this.sessionId,sessionIdExpiry:this.sessionIdExpiry,configurations:{eventSendingStrategy:this.eventSendingStrategy},featureToggles:{FT_3DA:this.FT_3DA,FT_3DA_UTM_SOURCE_LIST:this.FT_3DA_UTM_SOURCE_LIST,FT_3DA_STORAGE_LIFETIME:this.FT_3DA_STORAGE_LIFETIME},lockBrowsingStartOnSessionId:this.lockBrowsingStartOnSessionId,lockCheckoutStartOnSessionId:this.lockCheckoutStartOnSessionId,dataUpdatedAt:Date.now(),dataLayer:this.dataLayer};yield this.dataStorageManager.saveData(this.ANALYTICS_STORAGE_KEY,e)})}loadConfigurationFromServer(){return o(this,null,function*(){try{let e=new URL(`merchant/analytics/sdk/init/${this.merchantId}/${this.shopperCountryCode}`,this.cdn);e.searchParams.append("merchantId",this.merchantId);let t=yield this.http.get(e.toString());this.FT_3DA=t.FT_UtmReplaceSessionStorageWithCookies,this.FT_3DA_UTM_SOURCE_LIST=t.UtmAcceptableUtmSourceList,this.FT_3DA_STORAGE_LIFETIME=t.UtmParamsCookieLifetimeInMinutes}catch(e){this.logger.writeErrorLog({method:"AnalyticsSDK::loadMerchantConfiguration()",message:e.message,errorMessage:e.message})}})}setClientId(e){e?this.clientId=e:this.clientId||(this.clientId=U())}setSessionId(e){e&&(this.sessionId=e,this.sessionIdExpiry=Date.now()+30*60*1e3)}defineBrowserAccessor(e){if(e.browser===void 0||e.browser===null)throw new Error("The configuration.browser property should be defined.");if(t(e.browser))this.browser=new P(e.browser);else if(i(e.browser))this.browser=new M(e.browser.sessionStorage,e.browser.localStorage);else throw new Error("The provided configuration.browser is not supported (could be missing required properties of any of supported types).");function t(r){return typeof r=="object"&&r!==null&&"document"in r}function i(r){return typeof r=="object"&&r!==null&&"localStorage"in r&&"sessionStorage"in r}}defineEventSender(e){switch(this.eventSendingStrategy=e.eventSendingStrategy||0,this.eventSendingStrategy){case 0:this.eventSender=new F(this.DATA_TRACKING_SERVICE_API_URL,this.browser);break;case 1:this.eventSender=new G(this.DATA_TRACKING_SERVICE_API_URL,this.http);break;case 2:this.eventSender=new R(this.DATA_TRACKING_SERVICE_API_URL,this.http);break;case 3:this.eventSender=e.eventSender;break;default:throw new v(`enum value ${this.eventSendingStrategy}`)}}defineLogger(e){var t;switch(this.loggingStrategy=(t=e.loggingStrategy)!=null?t:0,this.loggingStrategy){case 0:this.logger=new _;break;case 1:this.logger=new k;break;case 2:this.logger=new B(new URL("logger",this.DATA_TRACKING_SERVICE_API_URL).toString(),{http:this.http});break;default:throw new v("Custom logger currently not supported.")}}defineUtmParametersHandler(){this.utms=new x(this.browser,this.logger,{FT_3DA:this.FT_3DA,FT_3DA_UTM_SOURCE_LIST:this.FT_3DA_UTM_SOURCE_LIST,FT_3DA_STORAGE_LIFETIME:this.FT_3DA_STORAGE_LIFETIME})}defineDataStorageManager(){this.dataStorageManager=new q(this.browser,this.logger)}updateSession(e){return o(this,null,function*(){(this.sessionId===void 0||this.sessionIdExpiry<e)&&(this.sessionId=U()),this.sessionIdExpiry=e+30*60*1e3,yield this.saveConfigurationSnapshot()})}queueEventSending(e,t){this.eventQueue.push({functionName:e,arguments:t})}queueEventDequeue(){for(;this.eventQueue.length>0;){let e=this.eventQueue.pop();if(e&&e.arguments){let t=Array.prototype.slice.call(e.arguments);this[e.functionName](...t)}else this.logger.writeInfoLog("Arguments are undefined or missing for this event")}}init(e,t,i){return o(this,null,function*(){this.merchantId=u(e).toBeDefined("The merchantId is required to load configuration."),this.shopperCountryCode=u(t).toBeDefined("The shopper country is required to load configuration."),this.cdn=u(i==null?void 0:i.cdn).toBeDefined("The CDN currently is required to load configuration. (should be changed in 2025 Q1)"),this.defineBrowserAccessor(i),this.defineLogger(i),this.defineEventSender(i),this.defineUtmParametersHandler(),this.defineDataStorageManager(),yield this.loadConfigurationSnapshot(),this.isConfigurationLoaded||(yield this.loadConfigurationFromServer()),this.setClientId(i.clientId),this.setSessionId(i.sessionId),this.userAgent=this.browser.getUserAgent(),this.screenResolution=this.browser.getScreenResolution(),yield this.utms.handle(i.utms),yield this.saveConfigurationSnapshot(),this.isInitialized=!0,this.queueEventDequeue()})}setMerchantCountryCode(e){return o(this,null,function*(){this.shopperCountryCode=u(e).toBeDefined("The shopperCountryCode is required to setup Analytics SDK."),yield this.saveConfigurationSnapshot()})}setDataLayer(e){return o(this,null,function*(){this.dataLayer=e,yield this.saveConfigurationSnapshot()})}sendBrowsingStartEvent(){return o(this,arguments,function*(){try{if(!this.isInitialized){this.queueEventSending(this.sendBrowsingStartEvent.name,arguments);return}let e=Date.now();if(yield this.updateSession(e),this.sessionId===this.lockBrowsingStartOnSessionId)return!1;this.lockBrowsingStartOnSessionId=this.sessionId,yield this.saveConfigurationSnapshot();let t=new L(e,this.clientId,this.sessionId,this.merchantId,this.shopperCountryCode,"Browsing Funnel",this.cdn,this.browser.getPageUrl(),this.browser.getPageTitle(),this.screenResolution,this.userAgent,this.browser.getReferrer(),this.utms.utmSource,this.utms.utmMedium,this.utms.utmCampaign,this.utms.utmTerm,this.utms.utmContent);return yield this.eventSender.send(t),!0}catch(e){this.logger.writeErrorLog({method:"AnalyticsSDK::sendBrowsingStartEvent()",message:e.message,errorMessage:e.message})}})}sendPageViewEvent(){return o(this,arguments,function*(){try{if(!this.isInitialized){this.queueEventSending(this.sendPageViewEvent.name,arguments);return}let e=Date.now();yield this.updateSession(e);let t=new D(e,this.clientId,this.sessionId,this.merchantId,this.shopperCountryCode,"Browsing Funnel",this.cdn,this.browser.getPageUrl(),this.browser.getPageTitle(),this.screenResolution,this.userAgent,this.browser.getReferrer(),this.utms.utmSource,this.utms.utmMedium,this.utms.utmCampaign,this.utms.utmTerm,this.utms.utmContent);yield this.eventSender.send(t)}catch(e){this.logger.writeErrorLog({method:"AnalyticsSDK::sendPageViewEvent()",message:e.message,errorMessage:e.message})}})}sendBrowsingFunnelEvent(i,r){return o(this,arguments,function*(e,t){try{if(!this.isInitialized){this.queueEventSending(this.sendBrowsingFunnelEvent.name,arguments);return}let n=Date.now();yield this.updateSession(n);let a=new N(e,n,this.clientId,this.sessionId,this.merchantId,this.shopperCountryCode,"Browsing Funnel",this.cdn,this.browser.getPageUrl(),this.browser.getPageTitle(),this.screenResolution,this.userAgent,this.browser.getReferrer(),this.utms.utmSource,this.utms.utmMedium,this.utms.utmCampaign,this.utms.utmTerm,this.utms.utmContent,t);yield this.eventSender.send(a)}catch(n){this.logger.writeErrorLog({method:"AnalyticsSDK::sendBrowsingFunnelEvent()",message:n.message,errorMessage:n.message})}})}sendCheckoutStartEvent(t){return o(this,arguments,function*(e){try{if(!this.isInitialized){this.queueEventSending(this.sendCheckoutStartEvent.name,arguments);return}let i=Date.now();if(yield this.updateSession(i),this.sessionId===this.lockCheckoutStartOnSessionId)return!1;this.lockCheckoutStartOnSessionId=this.sessionId,yield this.saveConfigurationSnapshot();let r=new O(i,this.clientId,this.sessionId,this.merchantId,this.shopperCountryCode,"Checkout Funnel",this.cdn,e,this.userAgent,this.utms.utmSource,this.utms.utmMedium,this.utms.utmCampaign,this.utms.utmTerm,this.utms.utmContent);yield this.eventSender.send(r)}catch(i){this.logger.writeErrorLog({method:"AnalyticsSDK::sendCheckoutStartEvent()",message:i.message,errorMessage:i.message})}})}sendCheckoutFunnelEvent(r,n,a){return o(this,arguments,function*(e,t,i){try{if(!this.isInitialized){this.queueEventSending(this.sendCheckoutFunnelEvent.name,arguments),this.logger.writeDebugLog("Exit sendCheckoutFunnelEvent without sending CheckoutFunnelEvent");return}let c=Date.now();yield this.updateSession(c);let l=new j(t,c,this.clientId,this.sessionId,this.merchantId,this.shopperCountryCode,"Checkout Funnel",this.cdn,e,this.userAgent,this.utms.utmSource,this.utms.utmMedium,this.utms.utmCampaign,this.utms.utmTerm,this.utms.utmContent,y(y({},this.dataLayer),i));this.logger.writeDebugLog("Sending CheckoutFunnelEvent"),yield this.eventSender.send(l)}catch(c){this.logger.writeErrorLog({method:"AnalyticsSDK::sendCheckoutFunnelEvent()",message:c.message,errorMessage:c.message})}})}};var Ie=H;return Se(ve);})();
//# sourceMappingURL=bundle.js.map
